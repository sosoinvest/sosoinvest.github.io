---
layout: single
title:  "이과식 정통 켈리공식: 최적의 포지션 사이즈 결정법"
description: 일반화된 켈리 공식에 따른 최적의 투자 포지션 결정 방법을 다룬 글
categories: 투자
tag: [주식,퀀트]
toc: true
author_profile: false
header:
 teaser: /images/2024-11-21-kelly-criterion/code-structure.webp
 og_image: /images/2024-11-21-kelly-criterion/Kelly_with_0.65.webp.webp
# sidebar:
#     nav: "docs"
# search: true
---
트레이딩의 승률과 수익률을 알고 있다고 할 때, 얼마의 돈을 한번의 트레이딩에 투입해야 할까? 다시 말해서 투자 포지션 사이즈를 어떻게 결정해야 최적의 수익률을 얻을 수 있을까?

미국의 과학자 존 래리 켈리 주니어는 이 문제에 대한 이론적인 답을 찾았다. 현재는 켈리 공식이라 불리는 간단한 수식이다.

# 존 래리 켈리 주니어(John Larry Kelly Junior)
[존 래리 켈리 주니어(John Larry Kelly Jr.)](https://en.wikipedia.org/wiki/John_Larry_Kelly_Jr.)는 1923년 미국의 텍사스에서 태어나 1965년 3월 18일 41세의 젊은 나이로 세상을 떠난 천재 과학자이다. 

1953년 텍사스 대학교 오스틴에서 물리학 박사 학위를 받았고, 벨 연구소에서 클로드 섀넌과 정보 이론 및 음성 합성을 연구하는 일을 했다. 

1956년 투자와 도박에서 최적의 배팅 금액을 결정하는 수식을 개발했는데, 이것이 오늘날 트레이더들에게 알려진 켈리 공식이다. 트레이더 뿐만아니라 워런 버핏과 [짐 사이먼스](/투자/jim-simons-book)도 투자금액을 결정할 때 켈리 공식을 사용한다고 한다.

<p align="center">   
    <img src="/images/2024-11-21-kelly-criterion/JohnLKellyJr.webp" alt="존 래리 켈리 주니어 사진">
    <br>
   <span style="font-style: italic; color: #FFFFFF;">Fig. 1 켈리 공식을 만든 존 래리 켈리 주니어</span>
</p>

# 켈리 공식
## 기본개념
이 공식은 한가지 가정에서 부터 시작한다. 만약 돈을 벌 수 있는 배팅 기회를 알고있다고 하자. 예를들어 동전을 던져서 앞면이나 뒷면이 나오는 것을 맞추면 배팅 금액의 N배(2~3배)를 돌려받는 도박을 생각해보면 된다. 이 도박을 반복한다면, 한번의 배팅에서 얼마의 돈을 걸어야 장기적으로 파산하지 않고 최대의 수익을 얻을 수 있는지 생각해봐야만한다. 만약 가진 돈을 전부 건다면 동전이 공정하다면, 50%의 확률로 모든 돈을 잃어버리게 된다. 또한 배당율이 작을 수록 돈을 걸 가치가 떨어진다. 

직관적으로 한번의 배팅에서 걸어야 하는 돈의 비율(배팅 비율)은 그 배팅의 승률과 배당율(성공하면 돈을 버는 비율) 그리고 손실율(실패하면 돈을 잃는 비율)에 따라 결정될 것으로 보인다. 켈리 공식은 이 세가지 파라미터(승률, 배당율, 손실율)를 가지고 장기적으로 자산 성장을 최대화하는 최적의 배팅 비율을 알려준다.

## 공식

### 일반식
일반화된 켈리 공식은 아래와 같다.

$$
f = \frac{p \cdot b - q \cdot l}{b \cdot (p \cdot l + q \cdot l)}  
$$

- $f$: 투자 비율
- $p$: 이길 확률
- $q$: 질 확률(1-p)
- $b$: 이겼을 때 얻는 수익률
- $l$: 졌을 때 잃는 손실율

만약, 손실율 $l<1$ 이라면, 즉, 투자금 중 일부 자본만 잃는 경우에는 실패 시 손실이 제한되므로, 손실율이 작으면 작을 수록 투자 비율($f$)이 높아진다. 이는 리스크가 감소하기 때문이다. 

만약 $l=0$ 이라면, 즉, 실패해도 손실이 없는 경우에는, 투자 비율은 무한대로 증가할 수 있으며, 모든 자본을 투자해도 위험이 없다.

### 특수식
일반식에서 $l=1$인 경우, 즉, 실패하면 모든 돈을 잃는 특수한 경우에는 수식이 다음과 같이 단순해진다.

$$
f = \frac{p \cdot b - q}{b}
$$

이 수식이 일반적으로 알려진 켈리 공식인데, 손실율이 100%인 특수한 경우라는 것은 누구도 잘 알려주지 않는 것 같다. 

도박이 아닌 트레이딩 같은 져도 일부의 돈만 잃는 경우에는 위의 일반식을 사용하는 것이 더 적합하다.

## 공식의 유도과정
공식의 유도과정을 따라가 보면 그 뒤에 있는 논리와 특징을 온전히 이해할 수 있다. 

먼저 성공과 실패의 수익률 정의부터 시작하자.

- 성공과 실패의 수익률 정의

기본적으로 투자 후 자본의 변화는 다음과 같다.

성공 시: $(1 + f \cdot b)$, 여기서 $b$는 성공 시 수익률

실패 시: $(1 - f \cdot l)$, 여기서 $l$은 실패 시 손실율

여기서 $f$는 투자 비율이다. $l$이 $1$보다 작으면 실패 시에도 일부 자본이 남게 된다.

- 기대값 설정

투자 결과의 로그 수익률의 기대값은 다음과 같이 표현된다. 

$$
E[\log(W)] = p \cdot \log(1 + f \cdot b) + q \cdot \log(1 - f \cdot l)
$$

여기서,

$p$: 성공 확률

$q = 1 - p$: 실패 확률

위의 수식은 단순히, $\text{이길 확률} \times \text{(1+수익률) + 질 확률}\times\text{(1-손실율)}$ 이다.

- 로그 기대값의 극대화

이 기대값을 $f$에 대해 미분하여 극대화한다.

$$
\frac{d}{df} \left[ p \cdot \log(1 + f \cdot b) + q \cdot \log(1 - f \cdot l) \right] = 0
$$

기대값의 미분은 다음과 같다.

$$
\frac{p \cdot b}{1 + f \cdot b} - \frac{q \cdot l}{1 - f \cdot l} = 0
$$

- 최적의 투자 비율$f$ 계산

위 식을 정리하면,

$$
\frac{p \cdot b}{1 + f \cdot b} = \frac{q \cdot l}{1 - f \cdot l}
$$

양변에 $(1 + f \cdot b)(1 - f \cdot l)$을 곱하면,

$$
p \cdot b \cdot (1 - f \cdot l) = q \cdot l \cdot (1 + f \cdot b)
$$

이를 정리하면,

$$
p \cdot b - p \cdot b \cdot f \cdot l = q \cdot l + q \cdot l \cdot f \cdot b
$$

$$
p \cdot b - q \cdot l = f \cdot (p \cdot b \cdot l + q \cdot l \cdot b)
$$

$f$에 대해 정리하면 아래와 같이 일반화된 켈리 공식이 유도된다. 

$$
f = \frac{p \cdot b - q \cdot l}{b \cdot l}
$$

더 간단히 다시 쓰면,
$$
f = \frac{p}{l}-\frac{q}{b}
$$

당연한 얘기지만, 위의 수식을 보면 $l$이 작을 수록, $b$가 클 수록 $f$는 커진다. 다시 말해, 손실이 작고 수익이 크면 배팅 사이즈가 커진다는 의미다.

손실율이 100%인 도박의 경우, $l=1$을 위의 공식에 대입하면 아래와 같은 특수식이 유도된다. 

$$
f = \frac{p \cdot b - q}{b}
$$

## $f$가 1보다 큰 경우
위의 일반화된 켈리 공식에서 계산된 $f$는 1보다 클 수 있다. 이는 특정 조건에서 모든 자본을 투자해도 충분하지 않을 정도로 기대 수익이 크다는 것을 의미한다. 다시말해서 레버리지 몰빵하라는 의미다.

반면에 손실율이 100%인 경우인 특수식에서 계산된 $f$는 1보다 클 수 없다. 단순히 생각해봐도 실패하면 100% 다 잃을 수도 있는데, 레버리지를 일으켜 투자하는게 말이 안된다.

일반식에서 $f$가 1보다 크려면, 분자(기대 수익)가 분모(위험 조정된 투자효율)보다 커야 한다. 

조건을 살펴보면, 
1. 성공 확률($p$)가 매우 높거나
2. 성공 시 수익률($b$)이 매우 크거나
3. 실패시 손실율($l$)이 매우 낮은 경우이다.

이러한 경우에는 분자가 커져서 $f$가 1보다 커질 수 있다.

그러나 현실적으로 $f>1$인 경우 실제 자본을 초과하는 레버리지를 사용해야해서, 높은 리스크를 동반하게 된다. 

켈리 공식은 정규분포 가정에서 유도된 것이기 때문에, 실제 투자에서 발생할 수 있는 극단의 경우, 즉, 팻 테일(fat tail)에 취약하다. 때문에 공식의 결과를 그대로 사용하기 보다는 현실적으로 1을 한계점으로 설정하고 전체 자본을 투자하는 것이 안전하다. 

트레이더들은 과도한 레버리지의 리스크 때문에 $f$의 50% 또는 25%를 수준만 사용한다고 한다.

# 적용 예
## 특이식
돈전 던지기를 한다고 해보자. 앞면과 뒷면이 나올 확률은 각각 50%이다. 만약 앞면이 나오면 투자금의 1.5배의 돈을 돌려주고, 지면 투자금을 모두 잃는다고 했을 때, 켈리 공식에 따르면 얼마의 돈을 걸어야 할까? 
위의 수식에, $p=0.5, q=0.5$, $b=1.5, l=1$을 대입하면, $f=0.1667$ 즉, 가진 돈의 16.67%만 걸어야 최적이다.

## 일반식
승률이 60%, 수익률이 20%, 손실율이 25%인 트레이딩 기회가 있다고 해보자. 이 경우, $b=0.2, l=0.25, p=0.6, q=0.5$이다. 

이 트레이딩을 반복했을 때, 자산성장을 최대화하기 위한 최적의 포지션 사이즈를 결정하고자한다. 위의 파라미터들을 켈리 공식에 대입하면,

$f=0.4$.

이 트레이딩에서는 가용금액의 40%만 투자해야 최적이다.

만약에 손실율이 10%로 낮아진다면($l=0.1$), 켈리 공식으로 결정된 최적의 투자 비율은,

$f=4$.

이 트레이딩은 수익성이 좋으므로 가용금액을 초과하여 레버리지를 일으키는 것이 좋다는 의미다. 다시말해서 개이득이므로 4배 레버리로 몰빵하라는 의미다.

# 특징 및 장점
1. 리스크 관리: 전체 자산을 한 번에 걸지 않고, 최적의 비율을 제시하여 리스크를 관리할 수 있다.

2. 장기적 성과: 단기적으로는 변동성이 있을 수 있지만, 장기적으로 기하급수적인 자본 성장을 최대화할 수 있다.
이 공식은 장기적으로 기하평균 수익률을 최대화하는 과정에서 유도되었다. 이는 복리 효과를 극대화하여 장기적인 자산 가치 증대로 이어진다.

3. 동적 조정: 시장 상황과 투자 성과에 따라 지속적으로 켈리 비율을 재계산하고 포지션을 조정할 수 있다. 이는 변화하는 시장 환경에 유연하게 대응할 수 있게 해준다.

4. 일관성 유지:켈리 비율을 따르면 감정적 의사결정과 충동적 행동의 영향을 줄이고 일관된 투자 전략을 유지할 수 있다.

5. 다각화 지원:켈리 비율은 여러 자산에 대한 최적의 투자 비중을 제시함으로써 포트폴리오를 다각화 할 수 있다.

# 한계와 주의할 점

1. 정확한 확률 추정의 어려움: 켈리 공식은 승률과 수익률에 대한 정확한 추정에 크게 의존한다. 그러나 금융 시장에서 이러한 확률을 정확히 추정하는 것은 매우 어렵다.

2. 높은 변동성: 켈리 공식의 결과를 그대로 적용하면 단기적으로 높은 변동성을 겪을 수 있다.

3. 과대 베팅 위험: 승률이나 배당률을 과대평가하면 과도한 베팅으로 이어질 수 있다. 따라서, 실제 적용 시 켈리 비율의 일부(예: 1/2 켈리, 1/4 켈리)만 사용하는 것이 일반적이다. 이를 부분 켈리 전략이라고 한다.

4. 비정규 분포 고려: 많은 금융 자산의 수익률은 정규 분포를 따르지 않는다. 극단적인 사건(fat tail)이 예상보다 자주 발생할 수 있어 이를 고려해야 한다.

5. 개인의 위험 선호도 미반영: 켈리 공식은 개인의 위험 선호도를 고려하지 않는다. 즉, 위험을 더 감수할 수 있는 투자자도 켈리 공식의 결과에 따르면 더 과소하게 포지션 사이즈를 결정할 수 있다. 반대도 마찬가지다.

# 수익률과 손실율에 따른 켈리 비율
아래에는 수익률(b)와 손실율(l)에 따라 계산한 켈리 공식의 결과를 표현한 contour plot이다. 

승률 40%부터 70%까지 7가지 경우에 대해 계산했다. 이 이외의 트레이딩은 현실과 괴리가 있기 때문에 고려대상이 아니다. 승률이 이보다 높기는 어렵고 이보다 낮으면 트레이딩할 가치가 없기 때문이다. 

수익률과 손실율은 0.5%~10% 범위의 값을 사용했다. 한번의 트레이딩에서 기대할만한 합리적인 범위의 값이라고 생각한다.

당연한 결과지만, 그림은 수익률이 높을수록, 손실율이 낮을수록 배팅 비율이 높다는 것을 시각적으로 보여준다.

## 승률 40%

<p align="center">   
    <img src="/images/2024-11-21-kelly-criterion/Kelly_with_0.4.webp" alt="p=0.4 일 때 켈리 비율">
    <br>
   <span style="font-style: italic; color: #FFFFFF;">Fig. 2 p=0.4 일 때 켈리 비율</span>
</p>

## 승률 45%

<p align="center">   
    <img src="/images/2024-11-21-kelly-criterion/Kelly_with_0.45.webp" alt="p=0.45 일 때 켈리 비율">
    <br>
   <span style="font-style: italic; color: #FFFFFF;">Fig. 3 p=0.45 일 때 켈리 비율</span>
</p>

## 승률 50%

<p align="center">   
    <img src="/images/2024-11-21-kelly-criterion/Kelly_with_0.5.webp" alt="p=0.5 일 때 켈리 비율">
    <br>
   <span style="font-style: italic; color: #FFFFFF;">Fig. 4 p=0.5 일 때 켈리 비율</span>
</p>

## 승률 55%

<p align="center">   
    <img src="/images/2024-11-21-kelly-criterion/Kelly_with_0.55.webp" alt="p=0.55 일 때 켈리 비율">
    <br>
   <span style="font-style: italic; color: #FFFFFF;">Fig. 5 p=0.55 일 때 켈리 비율</span>
</p>

## 승률 60%

<p align="center">   
    <img src="/images/2024-11-21-kelly-criterion/Kelly_with_0.6.webp" alt="p=0.6 일 때 켈리 비율">
    <br>
   <span style="font-style: italic; color: #FFFFFF;">Fig. 6 p=0.6 일 때 켈리 비율</span>
</p>

## 승률 65%

<p align="center">   
    <img src="/images/2024-11-21-kelly-criterion/Kelly_with_0.65.webp" alt="p=0.65 일 때 켈리 비율">
    <br>
   <span style="font-style: italic; color: #FFFFFF;">Fig. 7 p=0.65 일 때 켈리 비율</span>
</p>

## 승률 70%

<p align="center">   
    <img src="/images/2024-11-21-kelly-criterion/Kelly_with_0.7.webp" alt="p=0.7 일 때 켈리 비율">
    <br>
   <span style="font-style: italic; color: #FFFFFF;">Fig. 8 p=0.7 일 때 켈리 비율</span>
</p>