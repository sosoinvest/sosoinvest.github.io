---
layout: single
title:  "퀀트의 필수 요소 (5/7): 시스템 구현"
description: 퀀트 투자에 필요한 요소인 트레디이 시스템 구현에 대하여 정리하였다.
categories: 투자
tag: [주식,책,퀀트]
toc: true
author_profile: false
header:
 teaser: /images/2024-09-05-quant-elements-system/quant-elements-system-thumbnail.webp
 og_image: /images/2024-09-05-quant-elements-system/quant-elements-system-thumbnail.webp

# sidebar:
#     nav: "docs"
# search: true
---
퀀트 전략을 실현하기 위한 시스템 구현 방법에 대해 알아보자.

{: .notice--primary}
<span style="font-size: 1.25em;">이 글은 [퀀트의 정석] 책에 나오는 시스템 구현 부분을 정리한 것이다.</span>

[퀀트의 정석](/투자/quant-way-book/)

# 시장 미시구조
## 호가창
호가창은 영어로 LOB(Limit Order Book)라고 부른다. 그 이유는 모든 호가들이 전부 지정가 주문이기 때문이다.

호가창은 현재 시장가격을 기준으로 매수 주문들과 매도 주문들을 한 눈에 보여준다. 호가창에서 가장 싼 가격의 매도 호가를 '최우선 매도호가'라고 부르고, 반대로 가장 비싼 가격의 매수 호가를 '최우선 매수 호가'라고 부른다. 최우선 매도 호가와 최우선 매수 호가의 차이를 '매수-매도 스프레드'라고 부른다. 

<p align="center">   
    <img src="/images/2024-09-05-quant-elements-system/quant-elements-system-LOB.webp" alt="호가창 예시 그림">
    <br>
   <span style="font-style: italic; color: #FFFFFF;">Fig. 1 호가창</span>
</p>

매수-매도 스프레드는 현재 시장의 유동성에 대한 지표가 된다. 그 이유는 매수자와 매도자가 모두 거래를 꺼리는 상황이 발생하면 매수-매도 스프레드가 벌어지게 되고, 결국 시장에서 거래를 하는 것이 점점 더 어려워지기 때문이다. 시장가 주문을 내는 사람에게는 이러한 매수-매도 스프레드는 자신의 포지션을 구축하기 위해 지불해야하는 비용이된다.

## 주문방식
주문방식은 크게 시장가 주문과 지정가 주문이 있다.

시장가 주문은 체결 가격에 상관없이 주문을 내는 동시에 바로 체결되는 주문을 의미한다. 만약 매수 주문을 냈다면 시장에서 가장 낮은 매도 호가, 즉 회우선 매도 호가부터 찾아 주문을 체결시킨다. 어떤 가격에 체결되는지 보다 지금 바로 거래가 체결되는 것이 중요하기 때문에 시장가 주문은 호가창에 남아있는 유동성을 바로 흡수한다. 따라서 이러한 시장가 주문은 테이커(Taker)라고 표현하기도 한다.

지정가 주문은 말 그대로 체결되어야 하는 가격을 지정하여 주문을 내는 방식이다. 이렇게 제출된 지정가 주문은 호가창에 쌓이게 되고 시장에 유동성을 공급한다. 지정가 주문은 체결을 원하는 가격이 있기 때문에 시장가 주문과는 반대로 제출이 된다 하더라도 주문의 체결이 보장되는 것은 아니다. 예를들어, 내가 낸 지정가 매수 주문의 가격이 현재의 최우선 매수호가보다 낮다면 주문은 체결이 되지 않은 채 그대로 호가창에 머물어 있게 된다. 이러한 지정가 주문의 특성 때문에 종종 지정가 주문은 메이커(Maker)라고도 불린다. 

여기에 더해서 대량의 주문을 내는 방식에는 TWAP 와 VWAP 방식이 있다. 이러한 주문 방식들이 사용되는 이유는 자금의 규모가 매우 큰 경우 한꺼번에 주문을 내면 자신에게 불리한 가겨으로 체결될 확률이 높기 때문이다.

TWAP(Time-Weighted Average Price) 주문은 전체 체결 수량을 시간단위로 균등 분할하여 주문을 내는 방식을 의미하며, VWAP(Volume_Wieghted Average Price) 주문은 전체 체결 수량을 특정 기간 동안의 거래량에 비례하여 주문을 내는 방식을 의미한다.

## 틱데이터
틱은 거래가 새롭게 발생했을 떄의 그 순간을 의미한다. 또한 금융시장에서의 틱은 호가의 기본단위를 이야기하기도 한다. 어떤 주식에 대한 주문이 100원 단위로만 낼 수 있다면, 그 주식의 한 틱은 100원인 것이다.

틱 데이터는 기본적으로 시간, 가격, 그리고 거래량으로 이루어져있다. 즉, 특정 시점에 특정 가격으로 특정 수량만큼 발생한 모든 거래내역을 담고 있는 것이다.

## HFT
HFT는 High-Frequency Tradingm, 즉, '고빈도 매매'를 의미한다. 고빈도 매매를 정의하는 방식에는 여러가지가 있는데, 미국의 선물 규제 당국인 CFTC 산하의 기술 위원회의 정의에 따르면 고빈도 매매는 다음을 사용하는 자동화된 트레이딩의 형태를 의미한다.

- 의사결정, 거래주문 및 체결을 인간의 개입 없이 자동으로 처리하는 알고리즘

- 주문 체결에 대한 응답시간을 최소화할 수 있도록 설계된 저지연 기술

- 매매, 정정, 취소에 대한 주문을 빠른 속도로 처리할 수 있는 능력

일반적으로 HFT를 활용하는 비즈니스는 크게 알고리즘 주문체결, 차익거래, 마켓 메이킹, 그리고 패스트 알파로 분류된다. 

알고리즘 주문체결은 대규모 자금을 운용하는 기관투자자가 최소한의 거래비용을 지불할 수 있도록 주문체결 알고리즘 서비스를 제공하거나 혹은 기관 투자자가 직접 이러한 알고리즘을 제작하는 것을 의미한다.

차익거래는 지수 차익거래나 통계적 차익거래 같이 구조가 똑같거나 매우 유사한 두 상품 간에 괴리가 발생하는 경우를 통해 수익을 내는 것을 의미한다. 또한 동일한 상품이 여러 거래소에 상장되어 있는 경우 거래소간 차익거래를 하기도 한다.

마켓 메이킹은 완전 자동화된 알고리즘으로 시장에 유동성을 공급하는 시장 조성자의 역할을 하는 것을 의미한다.

패스트 알파는 이벤트 기반의 초단기 방향성 거래 전략이다. 방향성 거래는 장중 시장에서 매우 단기적인 추세를 포착한다. 이러한 형태의 전략은 고빈도매매 중에서도 가장 공격적이면서 자칫 잘못하면 시세조작이라는 법적인 문제를 만들 수도 있는 전략이다.

# 거래비용
많은 성공한 퀀트들은 그들이 벌어들이는 총 수익의 20~50%를 거래비용으로 지불한다고 한다. 이러한 거래비용은 두가지로 구분되는데, 하나는 명시적 비용이고, 다른 하나는 암시적 비용이다.

## 명시적 비용
명시적 비용은 우리가 명확하게 알 수 있는 거래비용을 의미한다. 여기에는 브로커에게 지불해야하는 커미션, 거래소에 지불해야하는 수수료, 그리고 세금이 있다.

브로커 커미션은 증권사에게 지불해야하는 수수료를 생각하면 된다. 이러한 수수료는 거래를 하기 전부터 명시적으로 공지가 되어 있기 때문에 우리는 실제 거래를 특정 사이즈만큼 체결한다면 정확히 얼마만큼의 비용이 나가게 될지 계산할 수 있다.

거래소 수수료는 거래소가 투자자로부터 받은 주문을 처리하여 원활하게 거래를 성사하는 역할에 지불하는 비용이다. 

마지막 세금은 양도소득세와 거래세가 있다.

## 암시적 비용
암시적 비용은 거래를 수행하기 전에는 정확히 추정할 수 없는 종류의 거래비용을 의미한다. 예를들어 어떤 자산을 매수하기 위해 시장가 주문을 냈다고 한다면, 이때 주문에 대한 실제 체결가격이 얼마나 될지 우리는 미리 알 수 없다. 여기서 실제 체결가격와 목표가격의 차이가 지불해야하는 암시적 비용이다. 이러한 암시적 비용에는 매수-매도 스프레드, 슬리피지, 기회비용, 그리고 마켓 임팩트가 있다.

매수-매도 스프레드는 현재 시장에서 최우선 매수 호가와 최우선 매도 호가의 차이를 의미한다. 이러한 차이는 시장의 유동성이 좋은 경우에는 매우 작지만, 반대로 모두가 거래를 꺼려하는 유동성이 작은 시장에서는 급격히 커지기도 한다. 즉, 매수-매도 스프레드는 시장의 상황에 따라 달라지는 변수이므로 우리는 이를 사전에 정확히 계산하지 못한다. 

슬리피지는 거래를 하기로 결정한 순간의 가격과 실제 주문이 체결된 가격 간의 차이를 말한다. 바닥에서 슬리퍼가 미끄러지듯이 실제 체결이 될 떄 까지 가격이 미끄러져서 발생하는 비용이다. 시장은 실시간으로 변화가 발생하는 장소이기 때문에 거래를 하기로 결정한 그 순간에도 시장가격은 움직인다. 따라서 매수 시그널이 발생한 시점의 가격과 실제 주문이 체결된 가격이 같을 확률은 매우 낮다. 

기회비용은 거래를 하지 않음으로써 발생하는 비용이다. 만약 거래를 했다면 얻을 수 있던 수익인데, 하지 않았기 때문에 놓쳐버린 기회가 바로 기회비용이다.

마켓 임팩트는 나의 주문이 호가창에 영향을 주어 내가 대량의 주문을 내면 낼 수록 나에게 더욱더 불리한 체결이 되는 것을 의미한다. 이 경우 이러한 주문 자체가 시장의 유동성에 영향을 미칠 수 있다. 시장에 존재하는 호가는 무한하지 않기 때문이다.

결론적으로 암시적 비용은 명시적 비용보다 훨씬 더 주의해야한다. 실제 거래비용의 대부분을 암시적 비용이 차지하고 있기 때문이다. 또한 암시적 비용은 정확히 계산하기가 쉽지 않고 시장의 유동성이 메마르는 경우 급격히 증가하는 경향이 있다.

# 트레이딩 시스템
트레이딩 시스템은 알고리즘에 의해 스스로 알아서 매매를 체결시키는 프로그램을 의미한다. 즉, 인간이 손으로 개입할 필요 없이 프로개름을 실행시키면 알아서 매매를 수행하는 기계인 것이다. 트레이딩 시스템이 필요한 이유는 퀀트가 설계한 팩터 포트폴리오를 정학하게 구현하기 위해서다. 팩터 포트폴리오의 운용은 상대적으로 매매 횟수가 빈번하게 발생하기 때문에 장중 거래량과 거래 시간대 및 유동서 같은 시장미시구조적 요소들을 고려하면서 매매를 해야한다. 

## 트레이딩 시스템의 구조
트레이딩 시스템의 구조는 거래소-런타임 프로세서-데이터베이스로 구성된다. 여기서 런타임 프로세서는 브로커나 거래소로부터 틱데이터인 실시간 호가를 수집하여 상황에 맞게 업무를 처리한다. 가장 기본적인 일은 데이터를 처리하여 실시간으로 매매 시그널을 만들어내는 것이다. 이렇게 생성된 매매 시그널은 실제 주문 체결로 연결되며, 알고리즘이 전송한 매매 주문을 받은 브로커 시스템은 이를 처리한 후 거래 체결에 대한 메세지를 다시 트레이딩 시스템으로 전송한다. 

또한 트레이딩 시스템은 매매를 수행하는 전과정에서 발생하는 모든 정보를 기록하는 역할도 있다. 여기에는 틱데이터인 실시간 가격, 거래내역, 손익, 거래비용 등이 포함된다. 이러한 정보는 모두 데이터베이스에 저장된다. 이러한 데이터는 전략의 실제 효과를 검증하기 위한 포워드 테스트에 사용되기도 하며, 이 데이터를 활용해 또 다시 새로운 전략을 개발할 수 있다. 또한 손익관리와 모니터링에 사용될 수도 있다.

<p align="center">   
    <img src="/images/2024-09-05-quant-elements-system/quant-elements-system-structure.webp" alt="트레이딩 시스템 구조 그림">
    <br>
   <span style="font-style: italic; color: #FFFFFF;">Fig. 2 트레이딩 시스템 구조</span>
</p>